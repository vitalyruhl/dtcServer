# Simplified test Dockerfile for fast CI/CD validation
FROM ubuntu:22.04

# Install all dependencies in one layer
RUN apt-get update && apt-get install -y \
    build-essential \
    cmake \
    git \
    curl \
    libcurl4-openssl-dev \
    libssl-dev \
    ca-certificates \
    nlohmann-json3-dev \
    zlib1g-dev \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

# Install JWT-CPP with nlohmann-json support
RUN git clone --depth 1 --branch v0.7.1 https://github.com/Thalhammer/jwt-cpp.git /tmp/jwt-cpp && \
    cd /tmp/jwt-cpp && \
    cmake -B build -DCMAKE_INSTALL_PREFIX=/usr/local -DJWT_BUILD_EXAMPLES=OFF -DJWT_JSON_TRAITS=nlohmann && \
    cmake --build build --parallel && \
    cmake --install build && \
    rm -rf /tmp/jwt-cpp

WORKDIR /app
COPY . .

# Build only essential components for Linux
RUN cmake -S . -B build \
    -DCMAKE_BUILD_TYPE=Release \
    -DENABLE_TESTING=ON \
    -DBUILD_TESTING=ON \
    -DBUILD_GUI_CLIENT=OFF

# Build the project
RUN cmake --build build --parallel $(nproc) --target coinbase_dtc_server test_basic test_dtc_protocol

# Simple validation that core components work
RUN echo "✅ Testing basic functionality..." && \
    ./build/test_basic && \
    echo "✅ Testing DTC protocol..." && \
    ./build/test_dtc_protocol && \
    echo "✅ Verifying server executable..." && \
    test -f ./build/coinbase_dtc_server && \
    echo "✅ All core tests passed!"

# Default command
CMD ["./build/coinbase_dtc_server"]